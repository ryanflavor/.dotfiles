name: Cross Review Mention

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      repo:
        required: true
        type: string
      pr_branch:
        required: true
        type: string
      base_branch:
        required: true
        type: string
      comment_body:
        required: true
        type: string
      comment_author:
        required: true
        type: string
        description: "GitHub username of the comment author"
      runner:
        required: true
        type: string
        description: "Runner labels as JSON array string"
      bot_name:
        required: true
        type: string
        description: "Bot username for filtering"
      model_claude:
        required: false
        type: string
        default: 'custom:claude-opus-4-6'
      model_gpt:
        required: false
        type: string
        default: 'custom:gpt-5.3-codex'
    secrets:
      CR_APP_ID:
        required: false
      CR_APP_PRIVATE_KEY:
        required: false
      GH_TOKEN:
        required: false

jobs:
  mention:
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Generate App Token
        id: app-token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CR_APP_ID }}
          private-key: ${{ secrets.CR_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr_branch }}
          fetch-depth: 0

      - name: Pull latest skills
        run: |
          cd ~/.dotfiles && git fetch origin && git reset --hard origin/main

      - name: Verify dependencies
        run: |
          for cmd in tmux droid gh python3; do
            command -v "$cmd" >/dev/null 2>&1 || { echo "Error: $cmd not found"; exit 1; }
          done

      - name: Handle Mention
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GH_TOKEN }}
          CR_MODEL_CLAUDE: ${{ inputs.model_claude }}
          CR_MODEL_GPT: ${{ inputs.model_gpt }}
          DROID_PR_NUMBER: ${{ inputs.pr_number }}
          DROID_REPO: ${{ inputs.repo }}
          DROID_BRANCH: ${{ inputs.pr_branch }}
          DROID_BASE: ${{ inputs.base_branch }}
          MENTION_BODY: ${{ inputs.comment_body }}
          MENTION_AUTHOR: ${{ inputs.comment_author }}
        run: |
          SAFE_REPO=$(echo "$DROID_REPO" | tr '/' '-')
          export CR_WORKSPACE="/tmp/cr-${SAFE_REPO}-${DROID_PR_NUMBER}"
          SKILL_DIR="$HOME/.factory/skills/cross-review"

          # Initialize workspace if not exists
          if [[ ! -d "$CR_WORKSPACE" ]]; then
            PR_NODE_ID=$(gh pr view "$DROID_PR_NUMBER" --repo "$DROID_REPO" --json id -q '.id')
            "$SKILL_DIR/scripts/cr-init.sh" \
              "$DROID_REPO" \
              "$DROID_PR_NUMBER" \
              "$DROID_BASE" \
              "$DROID_BRANCH" \
              "$PR_NODE_ID"
          fi

          export CR_SOCKET="$(cat "$CR_WORKSPACE/socket.path")"

          # Reset stale stage from previous run (prevent false "done" detection)
          echo "mention" > "$CR_WORKSPACE/state/stage"

          # Spawn Orchestrator in tmux to handle mention
          "$SKILL_DIR/scripts/cr-spawn.sh" orchestrator "custom:claude-opus-4-6"

          # Write mention content to a task file
          # SECURITY: comment_body comes from user input â€” use env var + printf, never heredoc
          TASK_FILE="$CR_WORKSPACE/tasks/mention-task.md"
          printf '%s\n' "# Mention Task" "" \
            "A user @mentioned the bot on PR #${DROID_PR_NUMBER}." \
            "Author: ${MENTION_AUTHOR}" "" \
            "## Comment" "" > "$TASK_FILE"
          printf '%s\n' "$MENTION_BODY" >> "$TASK_FILE"
          printf '\n%s\n' "## Instructions" \
            "Load skill: cross-review. Handle this mention appropriately." \
            "When done, write 'done' to ${CR_WORKSPACE}/state/stage." >> "$TASK_FILE"

          tmux -S "$CR_SOCKET" send-keys -t orchestrator:0.0 -l "Read and execute $TASK_FILE"
          tmux -S "$CR_SOCKET" send-keys -t orchestrator:0.0 Enter

          # Poll for completion (timeout 10 min)
          TIMEOUT=600
          ELAPSED=0
          while [[ $ELAPSED -lt $TIMEOUT ]]; do
            STAGE=$(cat "$CR_WORKSPACE/state/stage" 2>/dev/null || echo "")
            if [[ "$STAGE" == "done" ]]; then
              echo "Mention handled successfully."
              break
            fi
            if ! tmux -S "$CR_SOCKET" has-session -t orchestrator 2>/dev/null; then
              echo "Error: Orchestrator session died" >&2
              exit 1
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          if [[ "$(cat "$CR_WORKSPACE/state/stage" 2>/dev/null)" != "done" ]]; then
            echo "Error: Mention handling timed out after ${TIMEOUT}s" >&2
            exit 1
          fi

      - name: Cleanup
        if: always()
        env:
          DROID_REPO: ${{ inputs.repo }}
          DROID_PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          SAFE_REPO=$(echo "$DROID_REPO" | tr '/' '-')
          export CR_WORKSPACE="/tmp/cr-${SAFE_REPO}-${DROID_PR_NUMBER}"
          if [[ -d "$CR_WORKSPACE" ]]; then
            SKILL_DIR="$HOME/.factory/skills/cross-review"
            "$SKILL_DIR/scripts/cr-cleanup.sh" 2>/dev/null || true
          fi
