name: Cross Review

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      pr_branch:
        required: true
        type: string
      base_branch:
        required: true
        type: string
      repo:
        required: true
        type: string
      runner:
        required: false
        type: string
        default: '["self-hosted"]'
        description: "Runner labels as JSON array string"
      model_claude:
        required: false
        type: string
        default: 'custom:claude-opus-4-6'
        description: "Model for Claude agent"
      model_gpt:
        required: false
        type: string
        default: 'custom:gpt-5.3-codex'
        description: "Model for GPT agent"
    secrets:
      CR_APP_ID:
        required: false
      CR_APP_PRIVATE_KEY:
        required: false
      GH_TOKEN:
        required: false

jobs:
  check-branch:
    runs-on: ${{ fromJSON(inputs.runner) }}
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - id: check
        env:
          PR_BRANCH: ${{ inputs.pr_branch }}
        run: |
          if [[ "$PR_BRANCH" == cr/* ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  cross-review:
    needs: check-branch
    if: needs.check-branch.outputs.should_run == 'true'
    runs-on: ${{ fromJSON(inputs.runner) }}
    steps:
      - name: Generate App Token
        id: app-token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CR_APP_ID }}
          private-key: ${{ secrets.CR_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest skills
        run: |
          cd ~/.dotfiles && git fetch origin && git reset --hard origin/main

      - name: Verify dependencies
        run: |
          for cmd in tmux droid gh python3; do
            command -v "$cmd" >/dev/null 2>&1 || { echo "Error: $cmd not found"; exit 1; }
          done
          gh auth status

      - name: Initialize workspace
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GH_TOKEN }}
          DROID_REPO: ${{ inputs.repo }}
          DROID_PR_NUMBER: ${{ inputs.pr_number }}
          DROID_BASE: ${{ inputs.base_branch }}
          DROID_BRANCH: ${{ inputs.pr_branch }}
        run: |
          PR_NODE_ID=$(gh pr view "$DROID_PR_NUMBER" --repo "$DROID_REPO" --json id -q '.id')

          SKILL_DIR="$HOME/.factory/skills/cross-review"
          "$SKILL_DIR/scripts/cr-init.sh" \
            "$DROID_REPO" \
            "$DROID_PR_NUMBER" \
            "$DROID_BASE" \
            "$DROID_BRANCH" \
            "$PR_NODE_ID"

      - name: Cross Review
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GH_TOKEN }}
          CR_MODEL_CLAUDE: ${{ inputs.model_claude }}
          CR_MODEL_GPT: ${{ inputs.model_gpt }}
          DROID_PR_NUMBER: ${{ inputs.pr_number }}
          DROID_REPO: ${{ inputs.repo }}
          DROID_BRANCH: ${{ inputs.pr_branch }}
          DROID_BASE: ${{ inputs.base_branch }}
        run: |
          SAFE_REPO=$(echo "$DROID_REPO" | tr '/' '-')
          export CR_WORKSPACE="/tmp/cr-${SAFE_REPO}-${DROID_PR_NUMBER}"
          export CR_SOCKET="$(cat "$CR_WORKSPACE/socket.path")"

          SKILL_DIR="$HOME/.factory/skills/cross-review"

          # Spawn Orchestrator as interactive droid in tmux
          "$SKILL_DIR/scripts/cr-spawn.sh" orchestrator "custom:claude-opus-4-6"

          # Send initial prompt to Orchestrator
          # NOTE: -l sends text literally; Enter must be a SEPARATE send-keys call
          PROMPT="Load skill: cross-review. Execute the full review pipeline for PR #${DROID_PR_NUMBER} (${DROID_BRANCH} -> ${DROID_BASE}) in ${DROID_REPO}. model_claude=${CR_MODEL_CLAUDE} model_gpt=${CR_MODEL_GPT}. CRITICAL CONTEXT: The workspace is ALREADY initialized at $CR_WORKSPACE (do NOT re-run cr-init.sh). The tmux socket is $CR_SOCKET. You ARE the orchestrator running inside tmux — do NOT run cr-spawn.sh orchestrator, do NOT run cr-cleanup.sh, do NOT run kill-server. Start directly from Stage 1: spawn claude and gpt agents, then proceed through stages 2-5. When done, write 'done' to $CR_WORKSPACE/state/stage."
          tmux -S "$CR_SOCKET" send-keys -t orchestrator:0.0 -l "$PROMPT"
          tmux -S "$CR_SOCKET" send-keys -t orchestrator:0.0 Enter

          # Record tmux server PID and process tree info for diagnostics
          TMUX_SERVER_PID=$(tmux -S "$CR_SOCKET" display-message -p '#{pid}' 2>/dev/null || echo "")
          PANE_PID=$(tmux -S "$CR_SOCKET" display-message -t orchestrator:0.0 -p '#{pane_pid}' 2>/dev/null || echo "")
          echo "tmux server PID: $TMUX_SERVER_PID"
          echo "tmux socket: $CR_SOCKET"
          echo "Pane shell PID: $PANE_PID"
          echo "--- Process tree of tmux server ---"
          ps -o pid,ppid,pgid,sid,stat,comm -p "$TMUX_SERVER_PID" 2>/dev/null || true
          echo "--- Process tree of pane ---"
          pstree -p "$PANE_PID" 2>/dev/null || true

          # Background watchdog: capture pane + health status to RUNNER_TEMP
          WATCHDOG_LOG="${RUNNER_TEMP:-/tmp}/cr-watchdog-$$.log"
          PANE_LOG="${RUNNER_TEMP:-/tmp}/cr-pane-$$.log"
          echo "Watchdog log: $WATCHDOG_LOG"
          echo "Pane log: $PANE_LOG"
          (
            PREV_LINES=0
            while true; do
              TS=$(date -u +%H:%M:%S)
              WS_EXISTS="yes"
              [[ -d "$CR_WORKSPACE" ]] || WS_EXISTS="NO"
              if kill -0 "$TMUX_SERVER_PID" 2>/dev/null; then
                DROID_ALIVE="no"
                pgrep -P "$PANE_PID" -f droid >/dev/null 2>&1 && DROID_ALIVE="yes"
                echo "$TS tmux=alive droid=$DROID_ALIVE ws=$WS_EXISTS" >> "$WATCHDOG_LOG"
                # Capture full pane scrollback (append new lines only)
                FULL=$(tmux -S "$CR_SOCKET" capture-pane -p -J -t orchestrator:0.0 -S - 2>/dev/null || true)
                CUR_LINES=$(echo "$FULL" | wc -l)
                if [[ "$CUR_LINES" -gt "$PREV_LINES" ]]; then
                  echo "$FULL" | tail -n +$((PREV_LINES + 1)) >> "$PANE_LOG"
                  PREV_LINES=$CUR_LINES
                fi
              else
                echo "$TS tmux=DEAD ws=$WS_EXISTS (server PID $TMUX_SERVER_PID)" >> "$WATCHDOG_LOG"
                break
              fi
              sleep 10
            done
          ) &
          WATCHDOG_PID=$!
          echo "Watchdog PID: $WATCHDOG_PID"

          # Poll for completion (timeout 45 min)
          TIMEOUT=2700
          ELAPSED=0
          while [[ $ELAPSED -lt $TIMEOUT ]]; do
            STAGE=$(cat "$CR_WORKSPACE/state/stage" 2>/dev/null || echo "")
            if [[ "$STAGE" == "done" ]]; then
              echo "Cross review completed successfully."
              break
            fi

            # Diagnostic: check tmux server process
            if [[ -n "$TMUX_SERVER_PID" ]] && ! kill -0 "$TMUX_SERVER_PID" 2>/dev/null; then
              echo "Error: tmux server process $TMUX_SERVER_PID is dead at ELAPSED=${ELAPSED}s" >&2
              echo "--- Watchdog log ---"
              cat "$WATCHDOG_LOG" 2>/dev/null || echo "(missing)"
              echo "--- Orchestrator pane log (last 100 lines) ---"
              tail -100 "$PANE_LOG" 2>/dev/null || echo "(missing)"
              echo "--- Workspace dir ---"
              ls -la "$CR_WORKSPACE" 2>/dev/null || echo "Workspace GONE"
              kill "$WATCHDOG_PID" 2>/dev/null || true
              exit 1
            fi

            # Check if droid is still running
            if [[ -n "$PANE_PID" ]] && ! pgrep -P "$PANE_PID" -f droid >/dev/null 2>&1; then
              echo "Warning: droid process exited at ELAPSED=${ELAPSED}s"
              # Re-check stage — droid may have written 'done' right before exiting
              RECHECK_STAGE=$(cat "$CR_WORKSPACE/state/stage" 2>/dev/null || echo "")
              if [[ "$RECHECK_STAGE" == "done" ]]; then
                echo "Stage is 'done' — droid exited normally after completion."
                STAGE="done"
                break
              fi
              echo "--- Orchestrator pane log (last 100 lines) ---"
              tail -100 "$PANE_LOG" 2>/dev/null || echo "(missing)"
              kill "$WATCHDOG_PID" 2>/dev/null || true
              exit 1
            fi

            # Every 120s, show progress
            if (( ELAPSED % 120 == 0 && ELAPSED > 0 )); then
              echo "--- Progress at ${ELAPSED}s ---"
              tail -5 "$PANE_LOG" 2>/dev/null || true
              echo "---"
            fi

            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

          kill "$WATCHDOG_PID" 2>/dev/null || true

          if [[ "$STAGE" != "done" ]]; then
            echo "Error: Cross review timed out after ${TIMEOUT}s" >&2
          fi

          # Always dump orchestrator log
          echo "=== Orchestrator full pane log ==="
          cat "$PANE_LOG" 2>/dev/null || echo "(no pane log)"
          echo "=== Watchdog log ==="
          cat "$WATCHDOG_LOG" 2>/dev/null || echo "(no watchdog log)"

          if [[ "$STAGE" != "done" ]]; then
            exit 1
          fi

      - name: Cleanup
        if: always()
        env:
          DROID_REPO: ${{ inputs.repo }}
          DROID_PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          SAFE_REPO=$(echo "$DROID_REPO" | tr '/' '-')
          export CR_WORKSPACE="/tmp/cr-${SAFE_REPO}-${DROID_PR_NUMBER}"
          if [[ -d "$CR_WORKSPACE" ]]; then
            SKILL_DIR="$HOME/.factory/skills/cross-review"
            "$SKILL_DIR/scripts/cr-cleanup.sh" 2>/dev/null || true
          fi
